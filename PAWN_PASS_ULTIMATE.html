<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PAWN PASS // FINAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Syncopate:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.js"></script>
    <style>
        :root {
            --bg: #050505;
            --card: #111;
            --accent: #00ff9d;
            --text: #fff;
            --dim: #666;
            --border: #222;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }

        /* --- CORE LAYOUT FIX --- */
        body {
            background: var(--bg);
            color: var(--text);
            width: 100vw;
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic Height for Mobile Browsers */
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        nav {
            height: 60px;
            padding: 0 1.5rem;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border);
            background: rgba(5,5,5,0.95);
            flex-shrink: 0;
            z-index: 50;
        }
        .logo { font-weight: 800; font-size: 1.1rem; color: var(--accent); display: flex; align-items: center; gap: 0.5rem; }

        /* --- THE STAGE --- */
        .app-view {
            flex: 1;
            position: relative;
            width: 100%;
            overflow: hidden;
        }

        /* --- SCREENS --- */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg);
            display: flex; flex-direction: column;
            padding: 1.5rem;
            /* Safe area for iPhone Home Bar */
            padding-bottom: max(1.5rem, env(safe-area-inset-bottom));
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s;
            opacity: 0; 
            pointer-events: none; 
            transform: translateY(20px);
            z-index: 1;
        }

        .screen.active {
            opacity: 1; 
            pointer-events: auto; 
            transform: translateY(0); 
            z-index: 10;
        }

        .screen.prev {
            transform: scale(0.95);
            opacity: 0;
        }

        /* --- SCROLLABLE CONTENT AREA --- */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 1rem;
        }

        /* --- FIXED BUTTON AREA --- */
        .btn-area {
            margin-top: auto;
            flex-shrink: 0;
            padding-top: 1rem;
        }

        /* --- COMPONENTS --- */
        h1 { font-size: 2rem; font-weight: 800; margin-bottom: 0.5rem; line-height: 1.1; margin-top: 0.5rem; }
        .sub { color: var(--dim); margin-bottom: 2rem; font-size: 0.9rem; }

        select, input {
            width: 100%; background: #111; border: 1px solid var(--border);
            color: #fff; padding: 1rem; border-radius: 12px; font-size: 1rem;
            margin-bottom: 1rem; outline: none; appearance: none;
        }
        select:focus { border-color: var(--accent); }

        .btn-main {
            width: 100%; padding: 1.1rem; background: var(--accent);
            color: #000; font-weight: 800; border: none; border-radius: 12px;
            font-size: 1rem; cursor: pointer; margin-bottom: 0.5rem;
            box-shadow: 0 5px 20px rgba(0,255,157,0.15);
        }
        .btn-main:active { transform: scale(0.98); }

        /* --- QUOTE BOX --- */
        .quote-box {
            background: rgba(0,255,157,0.05); border: 1px solid var(--accent);
            padding: 1.5rem; border-radius: 16px; text-align: center; margin-bottom: 2rem;
        }
        .price-tag { font-size: 3rem; font-weight: 800; color: var(--accent); }

        /* --- SCANNER --- */
        #canvas-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; opacity: 0.6;
        }
        
        .scan-ui {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; z-index: 20;
        }

        .fingerprint-zone {
            width: 100px; height: 100px;
            border: 2px dashed #333; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 2rem; position: relative;
            transition: 0.3s;
        }
        
        /* Invisible Hit Box for easier touching */
        .fingerprint-zone::before {
            content: ''; position: absolute; top: -30px; left: -30px; right: -30px; bottom: -30px;
        }

        .fingerprint-zone.scanning { border-color: var(--accent); border-style: solid; box-shadow: 0 0 40px var(--accent); transform: scale(1.1); }
        .scan-icon { width: 50px; height: 50px; color: #333; transition: 0.3s; }
        .fingerprint-zone.scanning .scan-icon { color: var(--accent); }

        .progress-bar { width: 60%; height: 4px; background: #222; border-radius: 2px; overflow: hidden; }
        .fill { width: 0%; height: 100%; background: var(--accent); }

        /* --- SUCCESS SCREEN --- */
        .success-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .check-anim { width: 80px; height: 80px; color: var(--accent); animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }

    </style>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
     <!-- SCRIPT 1: LOGIC (Loads Instantly - Buttons will work immediately) -->
    <script>
        // --- NAVIGATION LOGIC ---
        function toScreen2() {
            const val = document.getElementById('itemSelect').value;
            document.getElementById('priceDisplay').innerText = '$' + val;
            switchScreen('screen1', 'screen2');
        }

        function toScreen3() {
            switchScreen('screen2', 'screen3');
            // Trigger the 3D init if it's ready, otherwise set a flag
            if(window.initParticles) window.initParticles();
            else window.startParticlesOnLoad = true;
        }

        function reset() {
            location.reload();
        }

        function switchScreen(fromId, toId) {
            document.getElementById(fromId).classList.remove('active');
            document.getElementById(fromId).classList.add('prev');
            
            const next = document.getElementById(toId);
            next.classList.add('active');
            next.classList.remove('prev'); // Reset just in case
        }

        // --- SCANNER LOGIC ---
        const zone = document.getElementById('scanZone');
        const fill = document.getElementById('scanFill');
        const text = document.getElementById('scanText');
        let isScanning = false;
        let scanProgress = 0;
        let scanInterval;

        function startScan(e) {
            if(e.cancelable) e.preventDefault(); // Prevent scrolling on touch
            isScanning = true;
            zone.classList.add('scanning');
            text.innerText = "VERIFYING...";
            text.style.color = "#00ff9d";
            
            // Start Loop
            clearInterval(scanInterval);
            scanInterval = setInterval(() => {
                if(isScanning) {
                    scanProgress += 2; // Speed of scan
                    fill.style.width = scanProgress + '%';
                    
                    // Trigger 3D acceleration if loaded
                    if(window.setScanState) window.setScanState(true);

                    if(scanProgress >= 100) {
                        clearInterval(scanInterval);
                        isScanning = false;
                        document.getElementById('successScreen').style.display = 'flex';
                    }
                }
            }, 20);
        }

        function stopScan() {
            isScanning = false;
            clearInterval(scanInterval);
            zone.classList.remove('scanning');
            text.innerText = "WAITING...";
            text.style.color = "#444";
            scanProgress = 0;
            fill.style.width = '0%';
            
            // Stop 3D acceleration
            if(window.setScanState) window.setScanState(false);
        }

        // Bind Events (Mouse & Touch)
        if(zone) {
            zone.addEventListener('mousedown', startScan);
            zone.addEventListener('touchstart', startScan, {passive: false});
            
            window.addEventListener('mouseup', stopScan);
            window.addEventListener('touchend', stopScan);
        }
        
        // Initialize Feather Icons
        if(typeof feather !== 'undefined') feather.replace();
    </script>

    <!-- SCRIPT 2: VISUALS (Loads Three.js - Can take a second) -->
    <script type="module">
        import * as THREE from 'three';
        
        // Re-run feather in case module loads fast
        if(typeof feather !== 'undefined') feather.replace();

        let renderer, scene, camera, particles;
        let is3DReady = false;

        // Make function global so Script 1 can call it
        window.initParticles = function() {
            if(renderer) return; // Already running
            
            const container = document.getElementById('canvas-container');
            if(!container) return;

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, container.offsetWidth/container.offsetHeight, 0.1, 1000);
            camera.position.z = 25;
            
            renderer = new THREE.WebGLRenderer({alpha:true, antialias:true});
            renderer.setSize(container.offsetWidth, container.offsetHeight);
            container.appendChild(renderer.domElement);

            const geo = new THREE.BufferGeometry();
            const count = 1500;
            const pos = new Float32Array(count*3);
            for(let i=0; i<count*3; i++) pos[i] = (Math.random()-0.5)*50;
            geo.setAttribute('position', new THREE.BufferAttribute(pos,3));
            
            const mat = new THREE.PointsMaterial({size:0.2, color:0x00ff9d, transparent:true, opacity:0.3});
            particles = new THREE.Points(geo, mat);
            scene.add(particles);
            
            is3DReady = true;
            animate();
        };

        // Allow Logic Script to control 3D state
        let scanState = false;
        window.setScanState = function(state) {
            scanState = state;
        };

        function animate() {
            requestAnimationFrame(animate);
            
            if(scanState) {
                // Fast Spin on Scan
                particles.rotation.z += 0.05;
                particles.material.opacity = 0.8;
                camera.position.z = Math.max(10, camera.position.z - 0.5);
            } else {
                // Idle Float
                particles.rotation.z += 0.002;
                particles.material.opacity = 0.3;
                camera.position.z = Math.min(25, camera.position.z + 0.5);
            }
            
            renderer.render(scene, camera);
        }

        // Check if logic requested start already
        if(window.startParticlesOnLoad) {
            window.initParticles();
        }
    </script>
</body>
</html>