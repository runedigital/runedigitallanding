<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RUNE // GHOST CONDUCTOR v1.4 [TURBO]</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; }
        canvas { display: block; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box;
        }

        #status-log {
            color: #00ffea; font-size: 12px; opacity: 0.8; text-shadow: 0 0 5px #00ffea;
        }

        #controls {
            align-self: center; pointer-events: auto; margin-bottom: 50px;
        }

        .btn {
            background: rgba(0, 255, 234, 0.1); border: 1px solid #00ffea; color: #00ffea;
            padding: 15px 30px; font-family: inherit; font-weight: bold; cursor: pointer;
            text-transform: uppercase; letter-spacing: 2px; transition: 0.3s;
            backdrop-filter: blur(5px);
        }
        .btn:hover { background: #00ffea; color: #000; box-shadow: 0 0 20px #00ffea; }
        
        #input-video { display: none; }
    </style>
</head>
<body>

    <video id="input-video" playsinline></video>

    <div id="ui-layer">
        <div id="status-log">
            // RUNE DIGITAL v1.4 [TURBO]<br>
            // SYSTEM: GHOST CONDUCTOR<br>
            // SIGNAL: WAITING...
        </div>
        <div id="controls">
            <button id="init-btn" class="btn" onclick="startBioLink()">[ INITIALIZE BIO-LINK ]</button>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <script type="module">
        import * as THREE from 'three';

        // --- THREE.JS SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050505);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 3, 8);

        const renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" }); // Antialias OFF for speed
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Cap pixel ratio
        document.body.appendChild(renderer.domElement);

        // LIGHTS
        const pLight1 = new THREE.PointLight(0x00ffea, 80, 50); pLight1.position.set(5, 5, 5); scene.add(pLight1);
        const pLight2 = new THREE.PointLight(0xff0055, 80, 50); pLight2.position.set(-5, 5, -5); scene.add(pLight2);

        // LIQUID MESH (Lower Poly Count)
        const geo = new THREE.PlaneGeometry(20, 20, 32, 32); // Reduced from 48
        const mat = new THREE.MeshStandardMaterial({ 
            color: 0x111111, roughness: 0.2, metalness: 0.9, 
            wireframe: true, emissive: 0x00ffea, emissiveIntensity: 0.1 
        });
        const plane = new THREE.Mesh(geo, mat);
        plane.rotation.x = -Math.PI / 2;
        scene.add(plane);

        // GHOST HAND
        const handGroup = new THREE.Group();
        scene.add(handGroup);
        
        const jointGeo = new THREE.BoxGeometry(0.2, 0.2, 0.2); // Box is faster than Sphere
        const jointMat = new THREE.MeshBasicMaterial({ 
            color: 0xff0055, wireframe: true, transparent: true, opacity: 0 
        });
        
        const joints = [];
        const targetPositions = []; 

        for(let i=0; i<21; i++) {
            const m = new THREE.Mesh(jointGeo, jointMat.clone());
            joints.push(m);
            handGroup.add(m);
            targetPositions.push(new THREE.Vector3(0,0,0));
        }

        let time = 0;
        let waveHeight = 0.5;
        let targetWaveHeight = 0.5;
        let isTracking = false;
        let globalOpacity = 0;
        const status = document.getElementById('status-log');
        const initBtn = document.getElementById('init-btn');

        // --- ANIMATION LOOP (60 FPS) ---
        function animate() {
            requestAnimationFrame(animate);
            time += 0.04;

            // Lerp Opacity
            globalOpacity = THREE.MathUtils.lerp(globalOpacity, isTracking ? 0.8 : 0, 0.1);
            
            // Update Joints
            for(let i=0; i<21; i++) {
                // Increased Lerp Factor (0.4) for snappier movement
                joints[i].position.lerp(targetPositions[i], 0.4); 
                joints[i].rotation.x += 0.05;
                joints[i].material.opacity = globalOpacity;
                joints[i].visible = globalOpacity > 0.01;
            }

            // Update Waves
            waveHeight = THREE.MathUtils.lerp(waveHeight, targetWaveHeight, 0.1);
            const positions = geo.attributes.position;
            for(let i=0; i<positions.count; i++){
                const x = positions.getX(i);
                const y = positions.getY(i);
                const z = Math.sin(x * 0.4 + time) * Math.cos(y * 0.4 + time) * waveHeight;
                positions.setZ(i, z);
            }
            positions.needsUpdate = true;
            
            renderer.render(scene, camera);
        }
        animate();

        // --- MEDIAPIPE (THROTTLED) ---
        window.startBioLink = async function() {
            initBtn.innerText = "INITIALIZING...";
            initBtn.disabled = true;
            status.innerHTML += "<br>// LOADING LITE MODELS...";

            const videoElement = document.getElementById('input-video');
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});

            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 0, // 0 = LITE (Fastest), 1 = FULL
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults(onResults);

            // Custom Loop for Detection (Not using Camera Utils to allow throttling)
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 320, height: 240, facingMode: 'user' } // Low Res Input
                });
                videoElement.srcObject = stream;
                await videoElement.play();
                
                initBtn.style.display = 'none';
                status.innerHTML += "<br>// SENSOR ACTIVE.";
                detectLoop(); // Start custom loop
            } catch(e) {
                console.error(e);
                status.innerHTML += "<br>!! ERROR: CAMERA BLOCKED";
            }

            async function detectLoop() {
                // Detect
                await hands.send({image: videoElement});
                // Loop again immediately (Browser handles timing)
                requestAnimationFrame(detectLoop);
            }
        };

        function onResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                isTracking = true;
                status.innerHTML = `// RUNE DIGITAL<br>// SIGNAL: <span style="color:#00ff00">LOCKED (LITE)</span>`;
                const landmarks = results.multiHandLandmarks[0];

                // Update Logic
                landmarks.forEach((lm, i) => {
                    const x = (lm.x - 0.5) * -12; 
                    const y = (lm.y - 0.5) * -10 + 3; 
                    const z = lm.z * -15; 
                    targetPositions[i].set(x, y, z);
                });

                // Wave Control
                targetWaveHeight = (1 - landmarks[0].y) * 3; 
                
                // Pinch Logic
                const dist = Math.hypot(landmarks[4].x - landmarks[8].x, landmarks[4].y - landmarks[8].y);
                if(dist < 0.05) mat.emissive.setHex(0xff0055); 
                else mat.emissive.setHex(0x00ffea);

            } else {
                isTracking = false;
                status.innerHTML = `// RUNE DIGITAL<br>// SIGNAL: <span style="color:#ff0055">SEARCHING...</span>`;
            }
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>